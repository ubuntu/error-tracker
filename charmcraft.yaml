name: error-tracker
type: charm
title: Error Tracker
summary: The whole infrastructure collecting and processing crashes for Ubuntu
description: |
  The Error Tracker is made of the following components:
    * daisy - receiving crashes
    * web UI - displaying and visualizing data for developers
    * timers - for processing and housekeeping tasks
    * retracer - to get symbolic stacktraces out of coredumps

  This charm can deploy either of those components depending on the
  configuration. Default to deploying everything.
links:
  source:
    - https://github.com/ubuntu/error-tracker/

platforms:
  ubuntu@24.04:amd64:

parts:
  error-tracker:
    source: .
    plugin: dump
  charm:
    source: .
    plugin: charm
    charm-entrypoint: charm/charm.py
    # This is the fastest way to get this charm to build:
    #   * uv plugin doesn't support charm-entrypoint
    #   * charm-requirements doesn't use binary Python packages, thus ends-up building some Rust
    # Update that list with the following:
    #   * uv sync --group charm-deps
    #   * uv pip freeze
    charm-binary-python-packages:
      - annotated-types==0.7.0
      - importlib-metadata==8.7.1
      - opentelemetry-api==1.39.1
      - ops==3.5.0
      - pydantic==2.12.5
      - pydantic-core==2.41.5
      - pyyaml==6.0.3
      - typing-extensions==4.15.0
      - typing-inspection==0.4.2
      - websocket-client==1.9.0
      - zipp==3.23.0

charm-libs:
  - lib: haproxy.haproxy_route
    version: "1"

config:
  options:
    enable_daisy:
      description: |
        Whether to enable the 'daisy' component of the Error Tracker
      default: true
      type: boolean
    enable_retracer:
      description: |
        Whether to enable the 'retracer' component of the Error Tracker
      default: true
      type: boolean
    enable_timers:
      description: |
        Whether to enable the 'timers' component of the Error Tracker
      default: true
      type: boolean
    enable_web:
      description: |
        Whether to enable the 'web' component of the Error Tracker
      default: true
      type: boolean
    configuration:
      description: |
        Full configuration file. Must be valid Python, will be imported directly by the errortracker.
      default: ""
      type: string
    retracer_failed_queue:
      description: |
        Whether the retracer will listen on the "failed_retrace_<arch>" queue
      default: false
      type: boolean

requires:
  route_daisy:
    interface: haproxy-route
    limit: 1
    optional: true
